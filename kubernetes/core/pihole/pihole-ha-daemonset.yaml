# Pi-hole HA DaemonSet mit hostNetwork für Client-IP Tracking
# 
# Features:
# - 3 Pods (ein pro Node) mit hostNetwork
# - DNS auf Port 53 auf jedem Node
# - Web Admin auf Port 80 auf jedem Node
# - Client-IPs werden korrekt angezeigt
# - Nebula-Sync für Config-Synchronisation
#
# Usage:
# - DNS: 192.168.1.10, .11, .12 (Port 53)
# - Web Admin: http://192.168.1.10/admin (oder .11, .12, .220)
# - Konfiguration nur auf Primary (192.168.1.10) ändern
# - Nebula-Sync synchronisiert alle 5 Min

---
apiVersion: v1
kind: Namespace
metadata:
  name: pihole
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pihole-ftl-config
  namespace: pihole
data:
  pihole-FTL.conf: |
    MAXDBDAYS=1
    DBINTERVAL=30.0
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: pihole
  namespace: pihole
spec:
  selector:
    matchLabels:
      app: pihole
  template:
    metadata:
      labels:
        app: pihole
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirst
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: pihole
              topologyKey: kubernetes.io/hostname
      
      securityContext:
        fsGroup: 999
      
      initContainers:
        - name: fix-permissions
          image: busybox:latest
          command: ['sh', '-c', 'chown -R 999:999 /etc/pihole /etc/dnsmasq.d && chmod -R 755 /etc/pihole /etc/dnsmasq.d']
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: config
              mountPath: /etc/pihole
            - name: dnsmasq
              mountPath: /etc/dnsmasq.d

      containers:
        - name: pihole
          image: pihole/pihole:2025.11.1
          ports:
            - containerPort: 53
              hostPort: 53
              protocol: UDP
              name: dns-udp
            - containerPort: 53
              hostPort: 53
              protocol: TCP
              name: dns-tcp
            - containerPort: 80
              hostPort: 80
              protocol: TCP
              name: http
          
          env:
            - name: TZ
              value: "Europe/Berlin"
            - name: PIHOLE_DNS_
              value: "192.168.1.1;8.8.8.8"
            - name: FTLCONF_webserver_api_password
              valueFrom:
                secretKeyRef:
                  name: pihole-password
                  key: password
            - name: FTLCONF_dns_listeningMode
              value: "all"
          
          volumeMounts:
            - name: config
              mountPath: /etc/pihole
            - name: dnsmasq
              mountPath: /etc/dnsmasq.d
            - name: ftl-config
              mountPath: /etc/pihole/pihole-FTL.conf
              subPath: pihole-FTL.conf
          
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
                - SYS_NICE
                - SYS_TIME
          
          resources:
            requests:
              memory: "256Mi"
              cpu: "150m"
            limits:
              memory: "768Mi"
              cpu: "600m"
          
          readinessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 20
            periodSeconds: 10
          
          livenessProbe:
            httpGet:
              path: /admin/
              port: 80
            initialDelaySeconds: 90
            periodSeconds: 30

      volumes:
        - name: config
          hostPath:
            path: /var/lib/pihole/config
            type: DirectoryOrCreate
        - name: dnsmasq
          hostPath:
            path: /var/lib/pihole/dnsmasq.d
            type: DirectoryOrCreate
        - name: ftl-config
          configMap:
            name: pihole-ftl-config
---
apiVersion: v1
kind: Service
metadata:
  name: pihole-web
  namespace: pihole
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.220
  selector:
    app: pihole
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
      name: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nebula-sync
  namespace: pihole
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nebula-sync
  template:
    metadata:
      labels:
        app: nebula-sync
    spec:
      containers:
      - name: nebula-sync
        image: ghcr.io/lovelaze/nebula-sync:latest
        startupProbe:
          httpGet:
            path: /api/auth
            port: 80
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 5
          failureThreshold: 12
        envFrom:
        - secretRef:
            name: nebula-sync-env
        env:
        - name: CRON
          value: "*/5 * * * *"
        - name: FULL_SYNC
          value: "false"
        - name: RUN_GRAVITY
          value: "true"
        - name: SYNC_MODE
          value: "SELECTIVE"
        - name: SELECTIVE_SYNC
          value: "adlist,domainlist,client"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - rpi4-cm4
